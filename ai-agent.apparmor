# ------------------------------------------------------------------
#
#    Copyright (C) 2026 Thomas Ziegler
#
#    This program is free software; you can redistribute it and/or
#    modify it under the terms of version 2 of the GNU General Public
#    License published by the Free Software Foundation.
#
# ------------------------------------------------------------------

abi <abi/4.0>,

include <tunables/global>

# @{HOME} also includes /root/
@{ONLY_HOME}=/home/*/

/usr/bin/{OpenCode,opencode-cli} {

  include <abstractions/base>
  include <abstractions/nameservice>
  include <abstractions/python>
  include <abstractions/ssl_certs>
  include <abstractions/dbus>
  include <abstractions/gtk>

  # Allow networking, we might want to limit this eventually
  network,

  # Allow signals, we might want to limit this eventually
  signal,

  # Shared libraries
  /lib/** mr,
  /usr/lib/** mr,
  /usr/local/lib/** mr,

  # Allow using binaries the agent might want to use
  /bin/* rix,
  /usr/bin/* rix,
  /usr/local/bin/* rix,
  /usr/lib/git-core/git rix,

  # Allow usage of shells
  /bin/bash rix,
  /bin/sh rix,

  # Allow stuff in /etc/
  /etc/hosts r,
  /etc/hostname r,
  /etc/default/** r,
  /etc/lsb-release r,
  /etc/ld.so.cache r,
  /etc/gtk-3.0/** r,

  # Allow stuff in /dev/
  /dev/tty* rw,
  /dev/pts/** rw,
  /dev/null rw,
  /dev/random r,
  /dev/urandom r,

  # Allow various things
  /usr/share/** r,
  /sys/** r,
  /tmp/ r,
  owner /tmp/** rwm,
  /proc/** r,

  # Allow access to certain directories in the user home
  / r,
  @{HOMEDIRS} r,
  @{ONLY_HOME} r,
  @{ONLY_HOME}/.local/** r,
  @{ONLY_HOME}/.local/share/{opencode,ai.opencode.desktop}/** rwklix,
  @{ONLY_HOME}/.local/state/opencode/** rwklix,
  @{ONLY_HOME}/.config/** r,
  @{ONLY_HOME}/.config/opencode/** rwkl,
  @{ONLY_HOME}/.bun/** rwkl,
  @{ONLY_HOME}/.cache/ rwkl,
  @{ONLY_HOME}/.cache/** rwkl,
  @{ONLY_HOME}/.gitconfig r,

  ############################################
  # Paranoia Section                         #
  #                                          #
  # explicit 'deny' always overrides,        #
  # so this makes sure those files are never #
  # whitelisted accidentially                #
  ############################################

  # Deny various things
  deny /root/** rwklx,
  deny /run/user/*/gnupg rwklx,
  deny /run/user/*/ssh-agent.info rwklx,
  deny /tmp/ssh-* rwklx,
  deny /tmp/keepassxc-* rwklx,

  # Ensure no direct storage-device access
  deny /dev/mapper/** rwkl,
  deny /dev/ubuntu-vg/** rwkl,
  deny /dev/nvme* rwkl,
  deny /dev/sd* rwkl,
  deny /dev/vd* rwkl,

  # Make sure it can't change profiles
  deny /etc/apparmor.d/** rwkl,
  deny /usr/share/apparmor/** rwkl,

  # Don't allow the agent to read your shell configs and history
  deny @{ONLY_HOME}/.bashrc rwklx,
  deny @{ONLY_HOME}/.bash_profile rwklx,
  deny @{ONLY_HOME}/.bash_history rwklx,
  deny @{ONLY_HOME}/.zshrc rwklx,
  deny @{ONLY_HOME}/.zsh_history rwklx,
  deny @{ONLY_HOME}/.zshenv rwklx,
  deny @{ONLY_HOME}/.profile rwklx,
  deny @{ONLY_HOME}/.config/fish/** rwklx,

  # Keep sensitive directories safe
  deny @{ONLY_HOME}/.ssh/** rwklx,
  deny @{ONLY_HOME}/.gnupg/** rwklx,
  deny @{ONLY_HOME}/.aws/** rwklx,

  # Make sure it can't elevate privileges
  # this should already be denied because it can't setuid
  deny /usr/**/sudo rwklx,
  deny /usr/**/su rwklx,

  # Deny using anything in /sbin or /usr/sbin
  deny /sbin/** rwklx,
  deny /usr/sbin/** rwklx,
  deny /usr/local/sbin/** rwklx,

  # add any additional rules into "local/opencode"
  # this will never change, so you can always replace this
  # file with a newer version
  include if exists "local/ai-agent"
}
